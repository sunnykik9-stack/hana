<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Synastry MVP</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <main class="container">
    <div class="headerbar">
      <div>
        <h1>Synastry MVP</h1>
        <p class="sub">두 사람의 출생 정보를 입력하고 결과를 확인해보세요.</p>
      </div>
      <label>
        <select id="theme" class="select" title="Theme">
          <option value="">Dusk</option>
          <option value="theme-aurora">Aurora</option>
          <option value="theme-blossom">Blossom</option>
        </select>
      </label>
    </div>

    <section class="cards">
      <div class="card">
        <h2>Person A</h2>
        <label>이름 <input id="a_name" placeholder="A"/></label>
        <label>생년월일 <input id="a_date" placeholder="1990-05-10"/></label>
        <label>출생시간 <input id="a_time" placeholder="08:20"/></label>
        <label>시간대 <input id="a_tz" placeholder="Asia/Seoul" value="Asia/Seoul"/></label>
      </div>

      <div class="card">
        <h2>Person B</h2>
        <label>이름 <input id="b_name" placeholder="B"/></label>
        <label>생년월일 <input id="b_date" placeholder="1992-11-22"/></label>
        <label>출생시간 <input id="b_time" placeholder="23:45"/></label>
        <label>시간대 <input id="b_tz" placeholder="Asia/Seoul" value="Asia/Seoul"/></label>
      </div>
    </section>

    <button id="btn" class="primary">궁합 계산하기</button>

    <section id="result" class="result" style="display:none;">
      <h3>결과</h3>
      <div id="score"></div>
      <ul id="aspects" class="aspects"></ul>
      <pre id="summary" class="summary"></pre>
    </section>

    <!-- GPT 해석 영역 -->
    <section id="readingBox" class="result" style="display:none;">
      <h3>GPT 해석</h3>
      <pre id="reading" class="summary"></pre>
    </section>
  </main>

  <script>
    async function compute() {
      const a = {
        name: document.getElementById('a_name').value || 'A',
        date: document.getElementById('a_date').value || '1990-05-10',
        time: document.getElementById('a_time').value || '08:20',
        tz:   document.getElementById('a_tz').value   || 'Asia/Seoul',
      };
      const b = {
        name: document.getElementById('b_name').value || 'B',
        date: document.getElementById('b_date').value || '1992-11-22',
        time: document.getElementById('b_time').value || '23:45',
        tz:   document.getElementById('b_tz').value   || 'Asia/Seoul',
      };

      // 간단 검증
      const must = v => v && v.trim().length > 0;
      if (!must(a.date) || !must(a.time) || !must(b.date) || !must(b.time)) {
        alert('생년월일과 출생시간을 모두 입력해 주세요.');
        return;
      }

      const btn = document.getElementById('btn');
      const resultBox  = document.getElementById('result');
      const scoreEl    = document.getElementById('score');
      const aspectsEl  = document.getElementById('aspects');
      const summaryEl  = document.getElementById('summary');
      const readingBox = document.getElementById('readingBox');
      const readingEl  = document.getElementById('reading');

      btn.disabled = true;
      btn.innerText = '계산 중...';

      try {
        // 1) 기본 계산
        const r1 = await fetch('/compute-synastry', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ personA:a, personB:b })
        });

        const body1 = await r1.text();               // 먼저 text로 받음
        if (!r1.ok) throw new Error(`compute-synastry ${r1.status}: ${body1.slice(0,300)}`);
        const data = JSON.parse(body1);              // 성공이면 JSON 파싱

        // 결과 렌더링
        resultBox.style.display = 'block';
        scoreEl.textContent = `스코어: ${data.score}`;

        aspectsEl.innerHTML = (data.aspects_top || []).map(x => {
          const sign = x.score_contrib >= 0 ? '+' : '';
          return `<li>
            <span class="badge ${x.type}">${x.type}</span>
            <strong>${x.bodies.join(' × ')}</strong>
            <span style="opacity:.8">· orb ${x.orb}</span>
            <span style="float:right;opacity:.9">${sign}${x.score_contrib}</span>
          </li>`;
        }).join('');

        summaryEl.textContent = data.summary || '';

        // 2) GPT 해석
        const r2 = await fetch('/generate-reading', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ score: data.score, aspects_top: data.aspects_top })
        });

        const body2 = await r2.text();
        let rr;
        try { rr = JSON.parse(body2); } catch { rr = { reading: null, error: body2 }; }

        readingBox.style.display = 'block';
        if (!r2.ok || !rr.reading) {
          readingEl.textContent = rr.error || body2 || '(해석 생성 중 오류)';
        } else {
          readingEl.textContent = rr.reading;
        }

      } catch (e) {
        alert('에러: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.innerText = '궁합 계산하기';
      }
    }

    document.getElementById('btn').addEventListener('click', compute);
  </script>
</body>
</html>
  <script>
    // ... (compute() 함수와 기존 코드 그대로)
    document.getElementById('btn').addEventListener('click', compute);

    // === 테마 선택 저장/복원 ===
    const themeSel = document.getElementById('theme');
    const saved = localStorage.getItem('synastry-theme');
    if (saved) { document.body.className = saved; themeSel.value = saved; }
    themeSel.addEventListener('change', () => {
      document.body.className = themeSel.value;
      localStorage.setItem('synastry-theme', themeSel.value);
    });
  </script>
