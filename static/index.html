
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Synastry MVP</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <main class="container">
    <h1>Synastry MVP</h1>
    <p class="sub">두 사람의 출생 정보를 입력하고 결과를 확인해보세요.</p>

    <section class="cards">
      <div class="card">
        <h2>Person A</h2>
        <label>이름 <input id="a_name" placeholder="A"/></label>
        <label>생년월일 <input id="a_date" placeholder="1990-05-10"/></label>
        <label>출생시간 <input id="a_time" placeholder="08:20"/></label>
        <label>시간대 <input id="a_tz" placeholder="Asia/Seoul" value="Asia/Seoul"/></label>
      </div>

      <div class="card">
        <h2>Person B</h2>
        <label>이름 <input id="b_name" placeholder="B"/></label>
        <label>생년월일 <input id="b_date" placeholder="1992-11-22"/></label>
        <label>출생시간 <input id="b_time" placeholder="23:45"/></label>
        <label>시간대 <input id="b_tz" placeholder="Asia/Seoul" value="Asia/Seoul"/></label>
      </div>
    </section>

    <button id="btn" class="primary">궁합 계산하기</button>

    <section id="result" class="result" style="display:none;">
      <h3>결과</h3>
      <div id="score"></div>
      <ul id="aspects"></ul>
      <pre id="summary" class="summary"></pre>
    </section>

    <footer class="footer">
      <small>MVP: 계산 정확도는 향후 개선 예정(황경 근사). · © Synastry MVP</small>
    </footer>
  </main>

  <!-- 여기부터 JS를 직접 포함 -->
  <script>
    async function compute() {
      const a = {
        name: document.getElementById('a_name').value || 'A',
        date: document.getElementById('a_date').value || '1990-05-10',
        time: document.getElementById('a_time').value || '08:20',
        tz:   document.getElementById('a_tz').value   || 'Asia/Seoul',
      };
      const b = {
        name: document.getElementById('b_name').value || 'B',
        date: document.getElementById('b_date').value || '1992-11-22',
        time: document.getElementById('b_time').value || '23:45',
        tz:   document.getElementById('b_tz').value   || 'Asia/Seoul',
      };

      const btn = document.getElementById('btn');
      btn.disabled = true;
      btn.innerText = '계산 중...';

      try {
        const res = await fetch('/compute-synastry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ personA: a, personB: b })
        });
        const data = await res.json();
        document.getElementById('result').style.display = 'block';
        document.getElementById('score').innerText = `스코어: ${data.score}`;
        const ul = document.getElementById('aspects');
        ul.innerHTML = '';
        (data.aspects_top || []).forEach(x => {
          const li = document.createElement('li');
          li.textContent =
            `${x.bodies.join(' × ')} — ${x.type} (orb ${x.orb}) · ${x.score_contrib >= 0 ? '+' : ''}${x.score_contrib}`;
          ul.appendChild(li);
        });
        document.getElementById('summary').innerText = data.summary;
      } catch (e) {
        alert('에러: ' + e);
      } finally {
        btn.disabled = false;
        btn.innerText = '궁합 계산하기';
      }
    }

    document.getElementById('btn').addEventListener('click', compute);
  </script>
</body>
</html>
<script>
  async function compute() {
    // ... (앞부분 그대로)

    try {
      const res = await fetch('/compute-synastry', { /* 그대로 */ });
      const data = await res.json();

      // 기존 렌더
      document.getElementById('result').style.display = 'block';
      document.getElementById('score').innerText = `스코어: ${data.score}`;
      const ul = document.getElementById('aspects');
      ul.innerHTML = '';
      (data.aspects_top || []).forEach(x => {
        const li = document.createElement('li');
        li.textContent = `${x.bodies.join(' × ')} — ${x.type} (orb ${x.orb}) · ${x.score_contrib >= 0 ? '+' : ''}${x.score_contrib}`;
        ul.appendChild(li);
      });
      document.getElementById('summary').innerText = data.summary;

      // === 여기부터 GPT 해석 호출 ===
      const r = await fetch('/generate-reading', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ score: data.score, aspects_top: data.aspects_top })
      });
      const rr = await r.json();

      // 해석 영역 만들어 붙이기
      let readingBox = document.getElementById('reading');
      if (!readingBox) {
        readingBox = document.createElement('div');
        readingBox.id = 'reading';
        readingBox.className = 'result';
        document.querySelector('main').appendChild(readingBox);
      }
      readingBox.innerHTML = `<h3>GPT 해석</h3><pre class="summary">${rr.reading || '(해석 생성 실패)'}</pre>`;

    } catch (e) {
      alert('에러: ' + e);
    } finally {
      btn.disabled = false;
      btn.innerText = '궁합 계산하기';
    }
  }

  document.getElementById('btn').addEventListener('click', compute);
</script>
